<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìÑ Room 1 - Documents Room</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 30px;
        font-size: 2.2em;
      }

      .status-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .status-card {
        padding: 20px;
        border-radius: 15px;
        border: 2px solid #e1e8ed;
      }

      .status-card h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #2c3e50;
      }

      .editor-status {
        font-size: 1.1em;
        font-weight: bold;
        padding: 10px;
        border-radius: 8px;
        text-align: center;
      }

      .can-edit {
        background: #d5f4e6;
        color: #22c55e;
        border: 2px solid #22c55e;
      }

      .observer {
        background: #fff7ed;
        color: #f59e0b;
        border: 2px solid #f59e0b;
      }

      .content-section {
        margin-bottom: 30px;
      }

      .content-section h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.3em;
      }

      textarea {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 2px solid #e1e8ed;
        border-radius: 12px;
        font-family: inherit;
        font-size: 16px;
        resize: vertical;
        box-sizing: border-box;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 12px 25px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .event-section {
        background: #f8f9ff;
        padding: 20px;
        border-radius: 15px;
        border-left: 5px solid #667eea;
      }

      .event-section h3 {
        margin-top: 0;
        color: #2c3e50;
      }

      .form-group {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      input[type='text'] {
        padding: 8px 12px;
        border: 2px solid #e1e8ed;
        border-radius: 6px;
        font-size: 14px;
        min-width: 150px;
      }

      input[type='text']:focus {
        outline: none;
        border-color: #667eea;
      }

      .navigation {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #ecf0f1;
        text-align: center;
      }

      .nav-btn {
        display: inline-block;
        padding: 10px 20px;
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin: 0 10px;
        transition: all 0.3s ease;
      }

      .nav-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
      }

      .users-list {
        max-height: 150px;
        overflow-y: auto;
      }

      .user-item {
        padding: 8px;
        border-bottom: 1px solid #ecf0f1;
        font-size: 14px;
      }

      .user-item:last-child {
        border-bottom: none;
      }

      .event-log {
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e1e8ed;
        border-radius: 8px;
        padding: 15px;
      }

      .event-entry {
        padding: 5px 0;
        border-bottom: 1px solid #f1f3f4;
        font-size: 13px;
      }

      .event-entry:last-child {
        border-bottom: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìÑ Room 1 - Documents Room</h1>

      <div class="status-panel">
        <div class="status-card">
          <h3>üë§ Users in Room</h3>
          <div id="roomUsers" class="users-list">
            <div class="user-item">Loading users...</div>
          </div>
        </div>

        <div class="status-card">
          <h3>‚úèÔ∏è Your Permission Status</h3>
          <div id="editorStatus" class="editor-status observer">üîÑ Checking permissions...</div>
        </div>
      </div>

      <div class="content-section">
        <h3>üìù Shared Document Content</h3>
        <p>
          <em
            >The first user to join can edit this content. Other users can only observe until the
            editor leaves.</em
          >
        </p>
        <textarea id="roomData" placeholder="Write your document content here...">
Loading document content...
        </textarea>
        <br />
        <button id="saveBtn" class="btn" onclick="saveContent()" disabled>üíæ Save Document</button>
        <button class="btn" onclick="refreshRoom()">üîÑ Refresh</button>
      </div>

      <div class="event-section">
        <h3>‚ö° Custom Events</h3>
        <p>
          <em
            >Editors can send custom events with additional data. Useful for notifications or
            specific actions.</em
          >
        </p>

        <div class="form-group">
          <label>Event ID:</label>
          <input type="text" id="eventId" placeholder="document-saved" value="document-saved" />
          <button id="sendEventBtn" class="btn" onclick="sendCustomEvent()" disabled>
            üì° Send Event
          </button>
        </div>

        <h4>üìä Event Log:</h4>
        <div id="eventLog" class="event-log">
          <div class="event-entry">No events yet...</div>
        </div>
      </div>

      <div class="navigation">
        <a href="index.html" class="nav-btn">ÔøΩÔøΩ Home</a>
        <a href="room2.html" class="nav-btn" onclick="return navigateWithConfig('room2.html')"
          >‚úÖ Room 2</a
        >
        <a href="room3.html" class="nav-btn" onclick="return navigateWithConfig('room3.html')"
          >üì¢ Room 3</a
        >
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="js/socket-client.js"></script>
    <script>
      const ROOM_ID = 'room1';
      let currentConfig = {};

      // Initialize room when DOM is ready
      document.addEventListener('DOMContentLoaded', function () {
        // Get configuration from URL
        const params = new URLSearchParams(window.location.search);
        currentConfig = {
          platform: params.get('platform') || 'room1',
          userId: params.get('userId') || '',
          name: params.get('name') || 'Nameless User'
        };

        console.log('üè† Initializing Room 1 with config:', currentConfig);

        // Wait for socket to be ready then configure user
        function initializeRoom() {
          if (socket && socket.connected) {
            console.log('üîå Socket ready, configuring user...');

            // Configure user automatically
            configUser(
              currentConfig.platform,
              currentConfig.userId ? parseInt(currentConfig.userId) : undefined,
              currentConfig.name
            );

            // Wait a moment and join the room
            setTimeout(() => {
              joinRoomWithPermissions(ROOM_ID, response => {
                if (response.ok) {
                  console.log('‚úÖ Joined room successfully');
                  updateInterface(response.room);
                } else {
                  console.error('‚ùå Failed to join room:', response.message);
                  alert('Error joining room: ' + response.message);
                }
              });
            }, 1000);
          } else {
            console.log('‚è≥ Waiting for socket connection...');
            setTimeout(initializeRoom, 100);
          }
        }

        // Start initialization
        initializeRoom();
      });

      // Handle room updates from server
      function handleRoomUpdate(roomData) {
        console.log('üîÑ Room update received:', roomData);
        updateInterface(roomData);
      }

      // Handle custom events
      function handleRoomEvent(eventData) {
        console.log('‚ö° Custom event received:', eventData);
        addEventToLog(
          `Custom Event: ${eventData.eventId} at ${new Date(
            eventData.timestamp
          ).toLocaleTimeString()}`
        );
      }

      function updateInterface(roomData) {
        // Update users list
        const usersElement = document.getElementById('roomUsers');
        if (roomData.users && roomData.users.length > 0) {
          usersElement.innerHTML = roomData.users
            .map(user => {
              const permission = user.canEdit ? '‚úèÔ∏è EDITOR' : 'üëÄ OBSERVER';
              const userId = user.userId ? ` (${user.userId})` : '';
              return `<div class="user-item"><strong>${user.name}</strong>${userId} - ${permission}</div>`;
            })
            .join('');
        } else {
          usersElement.innerHTML = '<div class="user-item">No users in room</div>';
        }

        // Update content
        const contentElement = document.getElementById('roomData');
        if (roomData.data && roomData.data.content !== undefined) {
          contentElement.value = roomData.data.content;
        }

        // Update permission status
        const currentUser = roomData.users
          ? roomData.users.find(user => user.socketId === socket.id)
          : null;
        const statusElement = document.getElementById('editorStatus');
        const saveBtn = document.getElementById('saveBtn');
        const sendEventBtn = document.getElementById('sendEventBtn');
        const contentTextarea = document.getElementById('roomData');

        if (currentUser && currentUser.canEdit) {
          statusElement.innerHTML = '‚úèÔ∏è You can EDIT this document';
          statusElement.className = 'editor-status can-edit';
          saveBtn.disabled = false;
          sendEventBtn.disabled = false;
          contentTextarea.readOnly = false;
          contentTextarea.placeholder = 'Write your document content here...';
        } else {
          statusElement.innerHTML = 'üëÄ You can only OBSERVE (read-only)';
          statusElement.className = 'editor-status observer';
          saveBtn.disabled = true;
          sendEventBtn.disabled = true;
          contentTextarea.readOnly = true;
          contentTextarea.placeholder = 'This document is read-only for you';
        }
      }

      function saveContent() {
        const content = document.getElementById('roomData').value;
        console.log('üíæ Saving content:', content);

        updateRoomData(ROOM_ID, { content: content }, 'document-saved', response => {
          if (response.ok) {
            console.log('‚úÖ Content saved successfully');
            addEventToLog('Document saved successfully');
          } else {
            console.error('‚ùå Error saving content:', response.message);
            alert('Error saving: ' + response.message);
          }
        });
      }

      function sendCustomEvent() {
        const eventId = document.getElementById('eventId').value.trim();
        if (!eventId) {
          alert('Please enter an Event ID');
          return;
        }

        const eventData = {
          message: 'Custom event triggered from Room 1',
          timestamp: new Date().toISOString(),
          eventType: 'custom',
          roomId: ROOM_ID
        };

        console.log('üì° Sending custom event:', eventId, eventData);

        updateRoomData(ROOM_ID, eventData, eventId, response => {
          if (response.ok) {
            console.log('‚úÖ Custom event sent successfully');
            addEventToLog(`Custom event sent: ${eventId}`);
          } else {
            console.error('‚ùå Error sending event:', response.message);
            alert('Error sending event: ' + response.message);
          }
        });
      }

      function refreshRoom() {
        console.log('üîÑ Refreshing room information');
        getRoomInfo(ROOM_ID, response => {
          if (response.ok) {
            console.log('‚úÖ Room info refreshed');
            updateInterface(response.room);
          } else {
            console.error('‚ùå Error refreshing room:', response.message);
          }
        });
      }

      function addEventToLog(message) {
        const logElement = document.getElementById('eventLog');
        const timestamp = new Date().toLocaleTimeString();
        const eventEntry = `<div class="event-entry"><strong>[${timestamp}]</strong> ${message}</div>`;

        if (logElement.innerHTML.includes('No events yet')) {
          logElement.innerHTML = eventEntry;
        } else {
          logElement.innerHTML = eventEntry + logElement.innerHTML;
        }
      }

      function navigateWithConfig(page) {
        const params = new URLSearchParams(currentConfig);
        window.location.href = `${page}?${params.toString()}`;
        return false;
      }

      // Leave room when page is closed
      window.addEventListener('beforeunload', function () {
        if (socket && socket.connected) {
          leaveRoomWithPermissions(ROOM_ID);
        }
      });
    </script>
  </body>
</html>
